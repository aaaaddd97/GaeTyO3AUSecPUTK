<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Residual Terminal</title>

<style>
body {
  background: black;
  color: #9f7cff;
  font-family: monospace;
  padding: 20px;
}

#terminal {
  white-space: pre-wrap;
  min-height: 400px;
}

input {
  background: black;
  color: #9f7cff;
  border: none;
  outline: none;
  width: 100%;
  font-family: monospace;
}
</style>
</head>

<body>

<!-- 顯示文字的終端區 -->
<div id="terminal"></div>

<!-- 輸入指令的地方 -->
<input id="cmd" disabled />

<script>
// ==========================
// 取得畫面元素
// ==========================
const term = document.getElementById("terminal");
const input = document.getElementById("cmd");
// ==========================
// 打字音效
// ==========================
const typeSound = new Audio("type.mp3");
typeSound.volume = 0.15; // 音量（0~1）

// ==========================
// 使用者帳號資料庫（之後可以一直加）
// ==========================
const accounts = {
  cucumber: {
    password: "cyxs",   // 密碼
    role: "player"      // 身分
  },

  margaret: {
    password: "rose",
    role: "support"
  },

  glitch: {
    password: "envy",
    role: "overlap"
  }
};


// ==========================
// 目前登入的使用者（預設沒登入）
// ==========================
let currentUser = null;


// ==========================
// 打字輸出（支援延遲）
// ==========================
function printLine(text, delay=40){
  return new Promise(resolve=>{

    let i = 0;

    let timer = setInterval(()=>{

      term.innerHTML += text[i];
      term.scrollTop = term.scrollHeight;

      // 每打一次字就播聲音
      typeSound.currentTime = 0;
      typeSound.play().catch(()=>{});

      i++;

      if(i >= text.length){
        clearInterval(timer);
        term.innerHTML += "<br>";
        resolve();
      }

    }, delay);

  });
}


// ==========================
// 一次印很多行（會照順序）
// ==========================
  
async function printLines(lines, delay=50){
  for(let line of lines){
    await printLine(line, delay);
  }
}

// ==========================
// 開機動畫
// ==========================
const bootLines = [
  "正在啟動終端機...",
  "正在載入記憶模組...",
  "正在恢復快取...",
  "偵測到殘留活動...",
  "正在初始化使用者介面...",
  "系統已準備就緒.",
  "使用者：未知",
  "輸入help獲取指令列表",
  ""
];

async function boot(){

  await printLines(bootLines, 40);

  // 開完機才能打字
  input.disabled = false;
  input.focus();
}

boot();


// ==========================
// Enter鍵送出指令
// ==========================
input.addEventListener("keydown", e=>{

  if(e.key === "Enter"){

    const cmd = input.value.trim();

    input.value = "";

    if(cmd){
      printLine("> " + cmd, 0);
      handle(cmd);
    }

  }

});


// ==========================
// 指令處理中心（所有指令都走這）
// ==========================
function handle(cmd){

  cmd = cmd.toLowerCase();

  // 如果還沒登入
  if(!currentUser && !cmd.startsWith("login")){
    printLine([
      "使用login 用戶名 進行登錄",
    ],30);
    return;
  }

  // login 指令
  if(cmd.startsWith("login")){
    login(cmd);
    return;
  }

  // 登入後的指令
  switch(cmd){

    case "help":
      showHelp();
      break;

    case "whoami":
      whoami();
      break;

    case "log":
      showLog();
      break;

    case "status":
      showStatus();
      break;

    case "logout":
      logout();
      break;

    default:
      printLine("未知指令", 30);
  }
}


// ==========================
// 登入流程
// ==========================
function login(cmd){

  // 取得帳號名稱
  // login cucumber → ["login","cucumber"]
  const parts = cmd.split(" ");

  if(parts.length < 2){
    printLine("使用login 用戶名 進行登錄");
    return;
  }

  const username = parts[1];

  // 查帳號是否存在
  if(!accounts[username]){
    printLine("未知的用戶名");
    return;
  }

  // 跳出密碼輸入框
  const pwd = prompt("輸入密碼");

  // 驗證密碼
  if(pwd === accounts[username].password){

    currentUser = {
      name: username,
      role: accounts[username].role
    };

    printLines([
      "登陸成功",
      "用戶: " + currentUser.name,
      "權限: " + currentUser.role,
      ""
    ],100);

  } else {

    printLine("登錄失敗",100);

  }
}


// ==========================
// 顯示 help（依權限不同）
// ==========================
function showHelp(){

  if(currentUser.role === "player"){

    printLines([
      "help, whoami, log, status, logout"
    ],20);

  }

  if(currentUser.role === "support"){

    printLines([
      "help, whoami, status, logout"
    ],20);

  }

  if(currentUser.role === "overlap"){

    printLines([
      "help, whoami, log, status, glitch, logout"
    ],20);

  }
}


// ==========================
// 顯示身分
// ==========================
function whoami(){

  printLines([
    "用戶: " + currentUser.name,
    "權限: " + currentUser.role
  ],30);

}


// ==========================
// 日誌（只有部分角色能看）
// ==========================
function showLog(){

  if(currentUser.role !== "player" &&
     currentUser.role !== "overlap"){

    printLine("沒有執行權限");
    return;
  }

  printLines([
    "[錯誤] 記憶體洩漏",
    "[警告] 偵測到未被格式化的文件",
    "[INFO] 腳本正在運行"
  ],30);

}


// ==========================
// 狀態
// ==========================
function showStatus(){

  printLines([
    "系統使趨穩定",
    "偵測到未被格式化的文件",
    "正在準備覆蓋"
  ],30);

}


// ==========================
// 登出
// ==========================
function logout(){

  currentUser = null;

  printLines([
    "用戶已登出",
    ""
  ],30);

}
</script>
</body>
</html>
