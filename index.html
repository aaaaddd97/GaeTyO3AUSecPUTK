<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Residual Terminal</title>

<style>
body {
  background: black;
  color: #9f7cff;
  font-family: monospace;
  padding: 20px;
}

#terminal {
  white-space: pre-wrap;
  min-height: 400px;
}

input {
  background: black;
  color: #9f7cff;
  border: none;
  outline: none;
  width: 100%;
  font-family: monospace;
}
</style>
</head>

<body>

<div id="terminal"></div>
<input id="cmd" disabled />

<script>

// ==========================
// 元素
// ==========================
const term = document.getElementById("terminal");
const input = document.getElementById("cmd");


// ==========================
// 多音效系統
// ==========================
let soundUnlocked = false;

// 建立音效池
const typeSounds = [
  new Audio("type1.mp3"),
  new Audio("type2.mp3"),
  new Audio("type3.mp3"),
  new Audio("type4.mp3"),
  new Audio("type5.mp3")
];

// 統一音量
typeSounds.forEach(s=>{
  s.volume = 0.15;
});

// 解鎖聲音（一定要）
document.addEventListener("click", unlockSound, { once:true });
document.addEventListener("keydown", unlockSound, { once:true });

function unlockSound(){

  if(soundUnlocked) return;

  // 解鎖所有音效
  Promise.all(
    typeSounds.map(s=>s.play().then(()=>{
      s.pause();
      s.currentTime = 0;
    }).catch(()=>{}))
  ).then(()=>{

    soundUnlocked = true;

  });

}


// 播聲音統一走這
function playTypeSound(){

  if(!soundUnlocked) return;

  // 隨機選一個音效
  const s = typeSounds[
    Math.floor(Math.random()*typeSounds.length)
  ];

  s.currentTime = 0;
  s.play().catch(()=>{});

}

// ==========================
// 帳號
// ==========================
const accounts = {

  cucumber:{ password:"cyxs", role:"player" },
  margaret:{ password:"rose", role:"support" },
  glitch:{ password:"envy", role:"overlap" }

};

let currentUser = null;


// ==========================
// 打字輸出
// ==========================
function printLine(text, delay=40){

  return new Promise(resolve=>{

    let i = 0;

    let timer = setInterval(()=>{

      term.innerHTML += text[i];
      term.scrollTop = term.scrollHeight;

      playTypeSound();

      i++;

      if(i >= text.length){

        clearInterval(timer);
        term.innerHTML += "<br>";
        resolve();

      }

    }, delay);

  });
}


// ==========================
// 多行輸出
// ==========================
async function printLines(lines, delay=40){

  for(let line of lines){
    await printLine(line, delay);
  }

}


// ==========================
// 開機
// ==========================
const bootLines = [

  "正在啟動終端機...",
  "正在載入記憶模組...",
  "正在恢復快取...",
  "偵測到殘留活動...",
  "正在初始化使用者介面...",
  "系統已準備就緒.",
  "使用者：未知",
  "輸入 help 獲取指令列表",
  ""

];

async function boot(){

  await printLines(bootLines,40);

  input.disabled = false;
  input.focus();

}

boot();


// ==========================
// 鍵盤監聽（修正版）
// ==========================
input.addEventListener("keydown", e => {

  // 播音效
  if(
    e.key.length === 1 ||
    e.key === "Backspace" ||
    e.key === "Enter"
  ){
    playTypeSound();
  }


  // Enter
  if(e.key === "Enter"){

    e.preventDefault();

    const cmd = input.value.trim();
    input.value = "";

    if(cmd){

      printLine("> " + cmd, 0);
      handle(cmd);

    }

  }

});


// ==========================
// 指令中心
// ==========================
function handle(cmd){

  cmd = cmd.toLowerCase();


  if(!currentUser && !cmd.startsWith("login")){

    printLine("請先 login 用戶名");
    return;

  }


  if(cmd.startsWith("login")){
    login(cmd);
    return;
  }


  switch(cmd){

    case "help": showHelp(); break;
    case "whoami": whoami(); break;
    case "log": showLog(); break;
    case "status": showStatus(); break;
    case "logout": logout(); break;

    default:
      printLine("未知指令");

  }

}


// ==========================
// 登入
// ==========================
function login(cmd){

  const parts = cmd.split(" ");

  if(parts.length < 2){
    printLine("用法: login 用戶名");
    return;
  }

  const name = parts[1];


  if(!accounts[name]){
    printLine("無此帳號");
    return;
  }


  const pwd = prompt("輸入密碼");


  if(pwd === accounts[name].password){

    currentUser = {
      name,
      role: accounts[name].role
    };

    printLines([
      "登入成功",
      "用戶: " + name,
      "權限: " + currentUser.role,
      ""
    ],60);

  }else{

    printLine("密碼錯誤");

  }

}


// ==========================
// help
// ==========================
function showHelp(){

  if(currentUser.role === "player"){

    printLine("help whoami log status logout");

  }

  if(currentUser.role === "support"){

    printLine("help whoami status logout");

  }

  if(currentUser.role === "overlap"){

    printLine("help whoami log status glitch logout");

  }

}


// ==========================
// whoami
// ==========================
function whoami(){

  printLines([
    "用戶: " + currentUser.name,
    "權限: " + currentUser.role
  ],40);

}


// ==========================
// log
// ==========================
function showLog(){

  if(!["player","overlap"].includes(currentUser.role)){

    printLine("權限不足");
    return;

  }

  printLines([
    "[ERROR] 記憶體洩漏",
    "[WARN] 檔案未格式化",
    "[INFO] 腳本運行中"
  ],40);

}


// ==========================
// status
// ==========================
function showStatus(){

  printLines([
    "系統穩定中",
    "殘留資料存在",
    "覆蓋準備中"
  ],40);

}


// ==========================
// logout
// ==========================
function logout(){

  currentUser = null;

  printLines([
    "已登出",
    ""
  ],40);

}

</script>
</body>
</html>
