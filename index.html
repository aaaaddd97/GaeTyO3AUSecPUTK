<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Residual Terminal</title>
<style>
body {
  background: black;
  color: #9f7cff;
  font-family: monospace;
  padding: 20px;
}

#terminal {
  white-space: pre-wrap;
  min-height: 400px;
}

input {
  background: black;
  color: #9f7cff;
  border: none;
  outline: none;
  width: 100%;
  font-family: monospace;
}
</style>
</head>
<body>

<div id="terminal"></div>
<input id="cmd" disabled />

<script>
// ==========================
// 元素
// ==========================
const term = document.getElementById("terminal");
const input = document.getElementById("cmd");

// ==========================
// 多音效系統
// ==========================
let soundUnlocked = false;

const typeSounds = [
  new Audio("type1.mp3"),
  new Audio("type2.mp3"),
  new Audio("type3.mp3"),
  new Audio("type4.mp3"),
  new Audio("type5.mp3")
];

typeSounds.forEach(s => s.volume = 0.15);

document.addEventListener("click", unlockSound, { once:true });
document.addEventListener("keydown", unlockSound, { once:true });

function unlockSound(){
  if(soundUnlocked) return;
  Promise.all(typeSounds.map(s => s.play().then(()=>{
    s.pause(); s.currentTime=0;
  }).catch(()=>{}))).then(()=>{ soundUnlocked = true; });
}

function playTypeSound(){
  if(!soundUnlocked) return;
  const s = typeSounds[Math.floor(Math.random()*typeSounds.length)];
  s.currentTime = 0;
  s.play().catch(()=>{});
}

// ==========================
// 帳號
// ==========================
const accounts = {
  "y3l_cu._":{ password:"Pride", role:"腳本" },
  "shield.of.hervia":{ password:"order", role:"插件" },
  "glitch":{ password:"envy", role:"未知" }
};

let currentUser = null;

// 系統忙碌鎖
let systemBusy = false;

// ==========================
// 打印單行
// ==========================
function printLine(text, delay=40){
  return new Promise(resolve=>{
    let i = 0;
    let timer = setInterval(()=>{
      term.innerHTML += text[i];
      term.scrollTop = term.scrollHeight;
      playTypeSound();
      i++;
      if(i >= text.length){
        clearInterval(timer);
        term.innerHTML += "<br>";
        resolve();
      }
    }, delay);
  });
}

// ==========================
// 打印多行
// ==========================
async function printLines(lines, delay=40){
  systemBusy = true;
  input.disabled = true;
  for(let line of lines){
    await printLine(line, delay);
  }
  systemBusy = false;
  input.disabled = false;
  input.focus();
}

// ==========================
// 開機
// ==========================
const bootLines = [
  "正在啟動終端機...",
  "正在載入記憶模組...",
  "正在恢復快取...",
  "偵測到殘留活動...",
  "正在初始化使用者介面...",
  "系統已準備就緒.",
  "使用者：未知",
  "輸入 help 獲取指令列表",
  ""
];

async function boot(){
  await printLines(bootLines,40);
  input.disabled = false;
  input.focus();
}

boot();

// ==========================
// keydown 事件
// ==========================
input.addEventListener("keydown", async e=>{
  if(systemBusy){ e.preventDefault(); return; }

  if(e.key.length===1 || e.key==="Backspace" || e.key==="Enter"){
    playTypeSound();
  }

  if(e.key==="Enter"){
    e.preventDefault();
    const cmd = input.value.trim();
    input.value = "";
    if(!cmd) return;

    systemBusy = true;
    input.disabled = true;

    await printLine("> " + cmd, 0);
    await handle(cmd);

    systemBusy = false;
    input.disabled = false;
    input.focus();
  }
});

// ==========================
// 指令中心
// ==========================
async function handle(cmd){
  cmd = cmd.toLowerCase();

  if(!currentUser && !cmd.startsWith("login")){
    await printLine("請使用 login 進行登錄");
    return;
  }

  if(cmd.startsWith("login")){
    await login(cmd);
    return;
  }

  switch(cmd){
    case "help": await showHelp(); break;
    case "whoami": await whoami(); break;
    case "log": await showLog(); break;
    case "status": await showStatus(); break;
    case "logout": await logout(); break;
    default: await printLine("未知指令"); break;
  }
}

// ==========================
// 登入
// ==========================
async function login(cmd){
  const parts = cmd.split(" ");
  if(parts.length<2){ await printLine("用法: login 用戶名"); return; }

  const name = parts[1];
  if(!accounts[name]){ await printLine("未知帳號"); return; }

  const pwd = prompt("輸入密碼");

  if(pwd===accounts[name].password){
    currentUser = { name, role: accounts[name].role };
    await printLines([
      "登入成功",
      "用戶: " + name,
      "權限: " + currentUser.role,
      ""
    ],60);
  }else{
    await printLine("密碼錯誤");
  }
}

// ==========================
// help
// ==========================
async function showHelp(){
  if(currentUser.role==="腳本") await printLine("help whoami log status logout");
  if(currentUser.role==="插件") await printLine("help whoami status logout");
  if(currentUser.role==="未知") await printLine("help whoami log status glitch logout");
}

// ==========================
// whoami
// ==========================
async function whoami(){
  await printLines([
    "用戶: " + currentUser.name,
    "權限: " + currentUser.role
  ],40);
}

// ==========================
// log
// ==========================
async function showLog(){
  if(!["腳本","未知"].includes(currentUser.role)){
    await printLine("權限不足"); return;
  }
  await printLines([
    "[ERROR] 記憶體洩漏",
    "[WARN] 檔案未格式化",
    "[INFO] 腳本運行中"
  ],40);
}

// ==========================
// status
// ==========================
async function showStatus(){
  await printLines([
    "系統穩定中",
    "殘留資料存在",
    "覆蓋準備中"
  ],40);
}

// ==========================
// logout
// ==========================
async function logout(){
  currentUser = null;
  await printLines(["已登出",""],40);
}
</script>
</body>
</html>

