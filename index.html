<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Residual Terminal</title>

<style>
body {
  background: black;
  color: #9f7cff;
  font-family: monospace;
  padding: 20px;
}

#terminal {
  white-space: pre-wrap;
  min-height: 400px;
}

input {
  background: black;
  color: #9f7cff;
  border: none;
  outline: none;
  width: 100%;
  font-family: monospace;
}
</style>
</head>

<body>

<div id="terminal"></div>
<input id="cmd" disabled />

<script>

// ==========================
// å…ƒç´ 
// ==========================
const term = document.getElementById("terminal");
const input = document.getElementById("cmd");

// ==========================
// å¤šéŸ³æ•ˆç³»çµ±
// ==========================
let soundUnlocked = false;

// å»ºç«‹éŸ³æ•ˆæ± 
const typeSounds = [
  new Audio("type1.mp3"),
  new Audio("type2.mp3"),
  new Audio("type3.mp3"),
  new Audio("type4.mp3"),
  new Audio("type5.mp3")
];

// çµ±ä¸€éŸ³é‡
typeSounds.forEach(s=>{
  s.volume = 0.15;
});

// è§£é–è²éŸ³ï¼ˆä¸€å®šè¦ï¼‰
document.addEventListener("click", unlockSound, { once:true });
document.addEventListener("keydown", unlockSound, { once:true });

function unlockSound(){

  if(soundUnlocked) return;

  // è§£é–æ‰€æœ‰éŸ³æ•ˆ
  Promise.all(
    typeSounds.map(s=>s.play().then(()=>{
      s.pause();
      s.currentTime = 0;
    }).catch(()=>{}))
  ).then(()=>{

    soundUnlocked = true;

  });

}


// æ’­è²éŸ³çµ±ä¸€èµ°é€™
function playTypeSound(){

  if(!soundUnlocked) return;

  // éš¨æ©Ÿé¸ä¸€å€‹éŸ³æ•ˆ
  const s = typeSounds[
    Math.floor(Math.random()*typeSounds.length)
  ];

  s.currentTime = 0;
  s.play().catch(()=>{});

}

// ==========================
// å¸³è™Ÿ
// ==========================
const accounts = {

  cucumber:{ password:"cyxs", role:"player" },
  margaret:{ password:"rose", role:"support" },
  glitch:{ password:"envy", role:"overlap" }

};

let currentUser = null;

// ç³»çµ±å¿™ç¢Œé–
let systemBusy = false;

  
// æ‰“å°å–®è¡Œï¼Œä¸è² è²¬è§£é–
function printLine(text, delay=40){
  return new Promise(resolve=>{
    let i = 0;
    let timer = setInterval(()=>{
      term.innerHTML += text[i];
      term.scrollTop = term.scrollHeight;

      playTypeSound();

      i++;
      if(i >= text.length){
        clearInterval(timer);
        term.innerHTML += "<br>";
        resolve();
      }
    }, delay);
  });
}

// æ‰“å°å¤šè¡Œï¼Œè² è²¬è§£é–
async function printLines(lines, delay=40){
  systemBusy = true;    // ğŸ”’ ä¸Šé–
  input.disabled = true;

  for(let line of lines){
    await printLine(line, delay);
  }

  systemBusy = false;   // ğŸ”“ è§£é–
  input.disabled = false;
  input.focus();
}



// ==========================
// é–‹æ©Ÿ
// ==========================
const bootLines = [

  "æ­£åœ¨å•Ÿå‹•çµ‚ç«¯æ©Ÿ...",
  "æ­£åœ¨è¼‰å…¥è¨˜æ†¶æ¨¡çµ„...",
  "æ­£åœ¨æ¢å¾©å¿«å–...",
  "åµæ¸¬åˆ°æ®˜ç•™æ´»å‹•...",
  "æ­£åœ¨åˆå§‹åŒ–ä½¿ç”¨è€…ä»‹é¢...",
  "ç³»çµ±å·²æº–å‚™å°±ç·’.",
  "ä½¿ç”¨è€…ï¼šæœªçŸ¥",
  "è¼¸å…¥ help ç²å–æŒ‡ä»¤åˆ—è¡¨",
  ""

];

async function boot(){

  await printLines(bootLines,40);

  input.disabled = false;
  input.focus();

}

boot();


// keydown äº‹ä»¶
input.addEventListener("keydown", e=>{
  // ç³»çµ±å¿™ç¢Œä¸­ â†’ ç¦æ­¢æ“ä½œ
  if(systemBusy){
    e.preventDefault();
    return;
  }
  
  // æ’­éŸ³æ•ˆ
  if(e.key.length === 1 || e.key === "Backspace" || e.key === "Enter"){
    playTypeSound();
  }


 
  // Enter
  if(e.key === "Enter"){
    e.preventDefault();
    const cmd = input.value.trim();
    input.value = "";
    if(cmd){
      printLine("> " + cmd, 0); // ç«‹å³é¡¯ç¤º
      handle(cmd);
    }
  }
});


// ==========================
// æŒ‡ä»¤ä¸­å¿ƒ
// ==========================
function handle(cmd){

  cmd = cmd.toLowerCase();


  if(!currentUser && !cmd.startsWith("login")){

    printLine("è«‹å…ˆ login ç”¨æˆ¶å");
    return;

  }


  if(cmd.startsWith("login")){
    login(cmd);
    return;
  }


  switch(cmd){

    case "help": showHelp(); break;
    case "whoami": whoami(); break;
    case "log": showLog(); break;
    case "status": showStatus(); break;
    case "logout": logout(); break;

    default:
      printLine("æœªçŸ¥æŒ‡ä»¤");

  }

}


// ==========================
// ç™»å…¥
// ==========================
function login(cmd){

  const parts = cmd.split(" ");

  if(parts.length < 2){
    printLine("ç”¨æ³•: login ç”¨æˆ¶å");
    return;
  }

  const name = parts[1];


  if(!accounts[name]){
    printLine("ç„¡æ­¤å¸³è™Ÿ");
    return;
  }


  const pwd = prompt("è¼¸å…¥å¯†ç¢¼");


  if(pwd === accounts[name].password){

    currentUser = {
      name,
      role: accounts[name].role
    };

    printLines([
      "ç™»å…¥æˆåŠŸ",
      "ç”¨æˆ¶: " + name,
      "æ¬Šé™: " + currentUser.role,
      ""
    ],60);

  }else{

    printLine("å¯†ç¢¼éŒ¯èª¤");

  }

}


// ==========================
// help
// ==========================
function showHelp(){

  if(currentUser.role === "player"){

    printLine("help whoami log status logout");

  }

  if(currentUser.role === "support"){

    printLine("help whoami status logout");

  }

  if(currentUser.role === "overlap"){

    printLine("help whoami log status glitch logout");

  }

}


// ==========================
// whoami
// ==========================
function whoami(){

  printLines([
    "ç”¨æˆ¶: " + currentUser.name,
    "æ¬Šé™: " + currentUser.role
  ],40);

}


// ==========================
// log
// ==========================
function showLog(){

  if(!["player","overlap"].includes(currentUser.role)){

    printLine("æ¬Šé™ä¸è¶³");
    return;

  }

  printLines([
    "[ERROR] è¨˜æ†¶é«”æ´©æ¼",
    "[WARN] æª”æ¡ˆæœªæ ¼å¼åŒ–",
    "[INFO] è…³æœ¬é‹è¡Œä¸­"
  ],40);

}


// ==========================
// status
// ==========================
function showStatus(){

  printLines([
    "ç³»çµ±ç©©å®šä¸­",
    "æ®˜ç•™è³‡æ–™å­˜åœ¨",
    "è¦†è“‹æº–å‚™ä¸­"
  ],40);

}


// ==========================
// logout
// ==========================
function logout(){

  currentUser = null;

  printLines([
    "å·²ç™»å‡º",
    ""
  ],40);

}

</script>
</body>
</html>
